use std::{
    collections::HashSet,
    ops::{Range, RangeBounds},
    sync::mpsc,
    time::Instant,
};

use rayon::iter::{
    IntoParallelIterator, IntoParallelRefIterator, ParallelBridge, ParallelIterator,
};
use wgpu::{PipelineCompilationOptions, util::DeviceExt};

const INPUT: &str = "@@.@@..@@@@@@@.@@.@..@@..@..@@.@@@@.@@@@@.@.@..@..@@@@.@@@@..@@.@@@@.@@....@.@.@@.@.@@@@@@@@@@@@.@@..@@@..@@.@@@@@....@.@@@@@@@@..@@..@
@@@@@@@@.@....@@@@@.@.@.@@@.@@...@@@.@@.@@@@@..@@.@@@@@@.@@@.@@@.@@@.@@.@@@.@.@@.....@@.@@@@@.@.@.@...@@@@..@.@@@@@@@.@@@@@..@@.@@...@.
@.@.@.@@@@@.@@..@@@@.@@@..@@..@@@...@@.@@..@@@.@@@@.@.@@@@@@.@@@@@.@..@@@.@@@.@.@.@..@@@@.@@..@@@@......@...@@...@@.@@@.@@@@..@..@.@.@@
...@@...@@@.@@@.@@.@..@@@...@@@@...@@@@@@.@@.@@@@.@@@@@@.@..@@@@@.@@@..@@@@.@@@@@@@.@.@@@...@.@@.@@.@@@@@@.@.@@@.@@..@..@.@.@@@@@...@.@
@@.@@@@@@@.@@@..@@.@.@@@@@@.@..@.@@@@@@.@@@@@@@@..@.@@.@.@@@@@.@.@@@@.@@@@@..@..@.@.@.@@@@.@@..@....@....@.@@..@@..@@..@.@@@.@@@@@@.@..
@@@@........@@...@@@@.@@..@@@@@@..@..@@@@@@.@.@@@@@@..@@@..@@.@@@.@@@..@@@.@@.@.@@..@@.@@@.@.@..@@..@@....@..@@.@.@..@@@@@.@@..@@@..@..
@@.@@@@.@.@@@@@...@@@@@@@.@@.@@@@@@.@@@.@@@...@.@@@.@@.@@@@@.@@..@@@@@@.@@@@.@@@@@@.@.@@@@@@@..@@@@.@@.@..@@@@....@@@.@@..@@@.@..@.@@.@
.@@@@....@@@.@@@@@@..@@@..@@@@.@@@@@@@@@@.@@@.@.@@@@@@...@.@@@@@@@@@.@@@@@@.@@@@...@@@@@@@@.@@@.@@@@@@.@@.@...@@@@@@.@@@..@...@@.@..@..
..@@@@...@@@@@@.@@@.@@@.@@..@@@@..@@..@@..@@@.@@@.@@@.@@.@@.@@...@@@@@.@.@@@@@@@@@@@..@@@@@@@@@@@@@@@@@@@@@@@...@@@@@@@.@.@.@@@.@@@@@@.
.@@...@.@.@@.@....@@@@@@@@@@......@@@@@@@..@@@@@@@@@@.@...@@.@..@@@@.@.@@@@@.@@@@@@@@@@@@@@@@@@.@@....@.@@.@.@@@.@@@.@@@@....@@.@.@@@@.
....@@@@@@.@@@@@@@.@..@@@@......@.@@...@@.@@@@@@.@.@@@...@.@@@.@@.@@.@@@@@@@@@@@.@@@@@.@@@.@@.@@@..@@@...@.@.@@@@@@@@@.@.@@@.@@@@@@@@@@
..@.@@.....@@@@@@@..@.@.@@@@@..@@@@.@.@@...@..@.@@..@@@@..@@.@@.@@@@.@@@@@@@..@@..@@@.@@@@..@@@...@@@@@@@@@.@@@@@@.@@.@@@@@.@@...@@@@.@
@@@..@@@.@@@@...@.@@..@.@.@@.@@@@@@.@.@@@@@@.@@.@.@@@@@.@.@.@@.@.@.@.@@@@@@@.@@@.@.@@@@@@..@@..@@...@..@@..@..@.@@..@.@@@@@@@@@@.@@@.@.
.@....@.@@.@..@.@.@@@..@@@@..@@@@.@.@@@@@@@.@@@@@.@@@@@@@@.@@@@@.@@.@...@@@@@.@.@.@@@.@@@@@@@@@@@@@.@@@..@@@@@@@@@..@....@@@.@@@..@@@.@
@@@@@.@@.@@@@.@@@...@@..@@.@@@@@@@@..@@@@@.@@.@.@@..@.@.@...@...@@@@@.@...@.@@@.@@@@@...@@@@.@.@@.@@@@@@.@@.@@@@@@@@...@@@.@.@.@.@@@...
.@@@@.@@.@@...@@@@.@@@.@@@@..@@.@@@@@.@@.@@@.@...@....@@@.@@@@..@@@@.@.@....@@@@@.....@@..@@@@..@..@@@@@@@.@@@.@@.@@@@@...@@.@..@@@@@.@
@@@..@@@@@@@.@@@@@@@.@@.@.@@..@@@@..@@.@@@.@.@@..@...@@@.@@....@.@@@@@.@@.@.@.@@@..@.@.@@....@@@@@.@@@@@@.@@@..@.@.@@@...@.....@.@@...@
@@@@@@@@@@@.@.@@..@@@@..@@@@@@@@@@.@@...@@@@..@@@@@@@@@@.@@..@..@@@..@@@@.@@.@.@@@.@.@@@@.@.@.@@.@@@.@@@@.@...@@@@..@@@@@@.@@@@@.@@.@@.
.@@@@@@@....@...@@@@@@.@.....@@@@@@@@.@@@.@@@@@@@@@@@@.@@@@..@.@@@.@..@....@@.@@@.@@@@.@@@@@@@.@@@@@@@.@.@.@@@@@@@.@..@...@@@@@.@@@@@@.
.@@@@@.@@.@.@@.@.@@.@.@@@@@@..@@@@@@..@@@@@..@@@@.@.@.@@@...@@@@@@@@@@..@@.@@@@@@@@@@....@.@..@@@..@@..@@@.@.@@.@@..@.@@@@.@@@@.@@.@..@
..@.@@@@@@@.@.....@.@@..@..@@@@@@.@....@@.@@@@...@@.@@@@@@@...@..@@@@@@.@@@@@@@.@@.@...@@@@.@@@@@@.@.@@@.@.@@@@..@@..@@@.@@.@@@.@@@@@.@
.@@@@.@@@@.@@.@@@.@@@.@@@@.@@@.@.@@@@@@@@..@@@.@@..@....@@@@.@@@@@@@.@@.@.@@..@.@..@@@..@..@@@.@@@@.@.@@@@@@@@@@@@.@@@@@@@.@@@..@.@@@.@
@@.@@@@@@@@@@.@.@@@@.@@.@@..@@@@.@@.@.@@@@@.@@@.@@..@.@@.@@.....@@.@.@@..@..@@.@@.@@@@@@.@@.@@@@.@@@@@@@@.@..@@@@@@@@@@@@@@@@@@.@@@@.@@
@@@@@.@@@..@...@@@@@@@@.@..@@@@@@@@@@.@@@@@@@@.@..@.@@@@@.@.@@.@@@@.@@@.@.@@@@@@@@@@..@@.@@@@@@@.@@.....@@@..@@@...@@@@.@@@@..@@.@@@@@@
@.@.@@@.@.@@@.@.@@.@@@@@.@@@@@..@..@@..@@@.@@@@@@@@.@@@..@.....@@@@@.@@@@@@@@.@.@@@@@.@@.@@@@@@.@@@@.@.@@.@@@@@@@@@@@..@@@@.@@@.@.@..@@
@..@.@@@.@.@..@.@.@@.@.@.@@@@.@....@@@@.@@.@.@...@@@@@@..@@@@@@.@@...@@@.@@@.@@..@@@.@@..@@@@...@.@@.@@@..@.@.@..@@.@@@@@@.@@.@...@@..@
@@@@@..@@@.@@@@.@@@.@@.@.@@.@@@@@...@@@@@@..@.@.@.@.@@.@...@.@@@.@@@@..@.@@@@@@....@@@.@@@@@@..@.@@@@@.@@@@@.@@..@@@.@..@@..@@@@..@@@@@
@@@@..@@@@.@@@@@@@@@..@.@@.@.@@@@......@..@@@@@.@@.@@@@@@..@@...@@@.@@@@@.@.@@.@.@.@.@.@@.@@@@@.@@@.@@.@.@@@@@@@@.@..@@.@@@@@.@@@@@....
@..@.@@....@@.@@@@.@@@.@...@.@@@@@@@@@@.@@@@@@@.@@.@@.@.....@.@@@@@@.@@@........@..@@.@@.@@@..@@@@....@@@@@@..@.@..@.@@@@@@.@.@@.@..@@@
@..@.@.@@@@..@..@@@@.@..@@.@@@.@.@@..@..@@@@.@@@@@.@@@.@@.@@..@..@@..@.@...@@.@@..@..@@.@.@@@@.@@@....@@..@.@@@@..@@@..@@@@.@@.@@@@@@..
@@.@.@@.@..@@.@@.@@@.@@.@@.@@.@@@@@.@@@@@.@.@.@.@@.@.@.@.@@.@..@@@..@.@@.@@..@.@...@@.@..@.@@@@@@.@@..@@..@..@.@@@@@@@.@@@..@@......@.@
@.@.@.@..@@..@..@@..@.@@@@.@@@.@...@@@@@@@..@@@.@.@@@@.@@@@@@@.@@@@..@....@@..@.@@..@...@..@.@.@.@.@@@@.@.@..@@@.@@@...@...@@@@.@@@@@@@
@..@@@@@@@@@@@@@..@@@..@@@@.@@.@@@..@@@@@@@.@@@@..@.@.@.@@@@.@.@@...@.@@..@.@@@@@@@@..@@@.@.@..@@@..@@..@@@@.@.@.@..@@@@.@..@@@..@.@.@.
...@...@@.@..@.@@@..@.@@.@....@@@@@.@@@@@.@@...@..@@@@@@...@@@.@@.@.@.@.@.@@@@@..@@@@@.@@..@@.@@@...@.@@..@.@@@@@@@@.@@@@@@.@@@@....@.@
.@@..@.@...@@@.@..@.@@@.@@@@@@@@@@.@@..@.@.@@@@@.....@@.@@...@.@...@@.@.@@@@..@@.@@@@@@@@.@@@.@..@@@..@@@@@@.@.@@@@.@.@@@.@@@....@@..@@
@@@@.@.@@.....@..@@@@.@..@@.....@@.@...@@@@@.@@@.@..@@@@@@.@@@@@@.....@.@@@@..@.@@.@..@@.@@@@.@@.@@.@.@@@.@@@@@.@@.@.@@@.@@@@@@..@@@..@
@@@@@.@.@@@@@@@..@@@@@.@@@.@.@@@@@@@@@@@@@@..@@@.@.@@@@.@@@@@@..@.@@@..@@.@.@.@@@@..@@@@@@...@@@@@.@.@.@...@.@@@...@@@@@@@@@@@..@@@@@@@
@.....@@@.@@@.@@@.@@.@@@@..@@.@@@@@@.@@.@@@..@.@@.@@.@@.@..@.@@.@@...@@@@..@@@@@@.@.@@.@@@.@@.@@..@@@@@..@@.@@.@@.@@.@@@.@..@@..@.@@@@.
@@@@@@..@@@@@.@.@@@@@@@@@@@@@@@@.@@.@.@@.@@@@@.@@@@.@@@@.@@@@.@@@.@.@@...@@@...@@@@..@@@@@@.@@@@@@@.@..@@.@@@..@@@.@..@.@@.@@@@@@.@@.@@
@@@@@@@@..@@@@.@@@@.@..@@@@@@.@@@@@@@..@@@@.@.@@@@@@.@@..@@.@@@@.@.....@@@@@..@..@.@@@@..@@.@@@.@@.@@.@@..@@.@@@@.@..@.@@@@@@@.@@@@@@@@
@.@@.@@.@@.@@@.@@..@@.@.@..@@@@@...@...@@@@.@@.@@...@@@@@...@@.@@.@.@@.@@...@@@@..@.@@@..@@..@@@....@@@@..@@@@@.@@@@@...@@@@@@.@.@@.@@.
@@@..@.@.@@.@@@@@.@.@@@@@.@@....@.@@.@@@@.@@..@.@@@@@@@@@.@@.@....@@@.@@@.@.@.@@.@@@@@@@@@@@@..@@@@@..@@.@.@.@@.@..@.@@..@@@@@@..@@@@@.
@@@..@..@.@.@@....@@@@@..@@@@@.@@@...@@@@.@@@@@.@@@.@@@@@.@@@@@@@.@@@.@@@@@.@@@@@@@@@@@..@@@@.@@@@@..@@@@.@@@.@@.....@@..@@.@@@@.@.@@@.
@.@@@...@@.@@@..@@@@@@.@@@@@..@@@@.@..@@@@@....@@@@@....@@...@@@.@@@@@@.@@@@@@@..@@.@@@.@.@@@@.....@..@@..@@@@.@@@@@.@@.@.@.@.@.@.@@.@@
@@.@.@.@.@@@@@@..@@@@@@@@@@@.@..@..@@@@@.@@..@@@..@@..@...@.@@.@@@@@@@@@@@@@.@@...@.@@.@@@.@...@@@@@.@@@@@@@@.@.@@...@.@@@..@@@@@@@@@@@
@@.@@@.@..@@@@@@.@@@@@.@.@@@@@@..@...@.@@@@@@.@@.@...@@@@@.@@..@@@.@..@@..@@@.@.@@@@@.@..@@..@@@@.@@@@@@.@.@@.@@@@@.@.@...@@@@@..@@.@@@
.@@@@@@@..@@@.@@@@.@@@@.@@@.@@.@@@@@.@@.@..@@..@@@.@@.@@@@@.@@@@@...@.@.@@@@@@.@@@....@@@@@@.@@.@..@@@..@..@@@.@..@@@@.@@.....@.@.@@...
.@@...@@@@@@@@@.@@..@@@@@@..@@@@@@@@@.@@@.@@@@@@@@@@@@.@@@@.@@..@@.@.@.@@.@@@@..@@@@..@@.@@@@@@@.@.@@@@.@..@@@@@@@@@.@@@@@@@@@@..@@@@@@
..@@.@@.@.@.@..@@@@@@.@@@@@@.@...@.@.@@..@@.@@.@.@@@..@@@@@@@@@.@....@..@.@@@@@@.@@.@@@@.@@@@.@@.@@@..@..@.@@@.@@@.@@@..@@@.@@@.@@@@..@
@@@@@..@@.@.@@@@@.@@.@@..@@@@.@@..@@@@.@..@@@@@@..@@@@@@@...@@@@@.@@@@.@@@@@@.@@..@.@@@@@@@@@@...@.@.@@@.....@@@@@..@@@.@@.@@.@.@.@@.@@
..@.@@@.@@.@.@@@@@@@@.@@..@@..@@.@.@@..@@@@..@@@.@@@.@@@@.@.@.@@@.@..@.@.@@.@@@.....@@..@@@@..@@@@@@@@..@@..@@@@.@@...@.@@@@@.@@..@@@@@
@@.@.@...@@@.@@.@@.@@.@.@.@@...@.@@@.@.@...@.@.@@@@@...@.@.@@@@...@....@@@@.@..@@@@@@@@@.@@.@@@@@@@@....@@@@@..@@.@@.@@.@.@@@..@.@@@@@@
@@@....@@@@..@...@.@.@@@@@@.@...@@@@@.@@.@....@@@.@..@.@.@...@..@@@.@.@.@@@@@@@@.@.@....@@@@...@@.@@.@@...@.@@@@@@@@@@@@@@@.@@.@...@@.@
@@@..@@..@@.@.@.@.@.@.@@@@@.@.@.@@.@@..@.@.@.@.@.@@@@@.@@@@.@...@@.@@...@@.@@.@@.@@@@..@..@...@@@@@.@.@.@@@.@@@@@@.@@@@..@.@.@.@@.@@@@@
..@@@.@@@@...@@.@@@@@@@.@@@@.@@@.@...@@@....@@@@@@@@.@.@@@@@.@@@@@.@.@@.@..@.@@@@@.@.@@.@@.@@.@@..@@..@@@.@...@@...@@@@@@@...@@..@@@...
.@@@@.@@@@.@.@@.@@@@@..@@@@.@@.@.@@@@@.@..@@@.@.@.@@.@@....@@...@@.@.@@.@@.@@@@@@..@@@@@@@@@.@@..@@...@@..@@@...@@@.@.@.@@@.@@.@@@@@@@@
.@.@@@.@..@@..@.@...@.@@@..@@@.@@.@@.@@@@@@..@.@@.@.@.@@..@@@...@@.@.@.@@.@@@.@@@.@@@@@.@@.@.@..@.@.@..@@@@@@@@@@..@@@@.@@@@@@@@@@...@.
.@@@@@@.@@@...@@@@@@@.@@@..@@@.@.@@..@.@@@@..@@@@@@.@@@@@@.@@@@@@@@.@.@@@.@..@.@@.@@@@@@@..@...@@..@.@.@@..@.@@.@@.@@@@@@.@@@@@@@@@@@.@
@.@@@@.@.@.@....@@@@@...@@@@@@@@..@.@@@.@.@.@.@@.@.@..@@.@.....@@@@@@@@@@@@@.@@@@@@@@@@..@...@@@@@@@.@..@.@@@@..@.@@.@@@@.@@@@@@@..@@@.
@...@@@.@@..@@@.@@@@@@.@.@@@@..@@..@@@@.@@@.@@@@@@.@@...@@@@@@@@..@@.@@.@@@....@@@@.@.@@@@@.@@@@@.@@@@@.@@@@@@@.@..@@.@@.@.@.@......@@.
.@@@..@.@..@@.@@..@@.@@...@@.@@@@@..@@.@@@.@@@@@....@@@.@@@.@@.@@@.@@.@....@@.@.@@@@..@.@@.@.@@@.@.@@.@@..@@@@.@@.@@..@@@..@@@.@.@@..@@
..@@@.@@@..@.....@@@@@@.@.@@@@@@.@.@@.@@@@..@@@.@.@.@...@@@@@.@@@@@@@@@@@@.@@...@@@.@@@@@@@@..@..@@@@@@@.@@@.@..@@@.@@@@@@.@@@@.@@@@.@@
.@@@@@.@@@@.@.@@@@.@@@@@...@@.@@@@@@.@@@..@.@@.@@.@.@@@@..@@...@@@@@.@@.@@.@@@@.@@@@@@...@@@@...@@.@@..@@@@@.@@.@@.@@..@@@@@@@.@@.@@@@@
...@....@@.@.@@@@@@..@@.@@.@@@@.@@@@...@.@@@@.@..@@.@@@.@@@.@@@@@@.@@@...@@@@@@..@@@@.@@@@@@@@@@@..@@@@@..@.@@@@.@.@@@@@@@@@@@@@@@@@@@@
.@@@@@.@..@@@@..@@@@@@@@.@.@@.@@@.@@@@@@@.@.@@..@@..@...@.@@@.@..@@@@@@.@@@.....@@@@.@@@.@@@@@@@@@@...@@..@..@.@@.@@@.@.@@.@@@@@.@..@@.
@@.@.@.@@@..@@.@..@..@@@@@...@@@@.@..@.@@@.@@@@@@..@@@@@.@@@@@@.@@.@@@@@.@@.@@.@@@@@@..@@@.@@@@.@@..@@...@@@@@@@@@@.@.@@@@@@@..@@@..@..
.@.@.@.@@@@...@@..@@.@@@@@@@@.@@@@@@.@@@@@.@@@@.@@@@@@.@.@@@@.@@.@.@@@.@.@@@@.@...@@.@@@.@@@@@...@@@.@@@@@@.@@..@@@...@@.@@@..@.@@.@.@@
@.@@.@@..@@@@...@@.@@@@.@@@.@@.@@@@@.@@@@@@@@@@.@.@@.@@@..@@@.@...@@@@@@..@@@@@@@.@@...@@@.@..@@.@@.@@.@@@.@.@.@@.@.@@...@..@.@@@@@@@@@
@..@@@@.@@@@@.@@@@@@@.@@@@@@@@.@@.@.@@@@@@@@@@@@@@@@@@.@@@..@...@@@@@@@@@.@@..@.@.@@@..@.@@.@@@@@@@@@@.@@.@@@..@@.@@@@.@@..@.@@.@@@@@@@
@@@@@@@@@@.@@@..@@@.@..@@...@.@@.@@.@.@@@@@..@@@@.@@@.@@@..@.@@@@@.@@@@....@..@@@@@.@..@@@.@@@@....@@.@@.@@.@.@@@@...@..@@@.@.@...@@@@@
@.@@@@@@@@@@@@..@@@@@@.@.@@@.@.@...@@@...@@@@@@.@@@@..@..@@@.@@.@@..@@@@@....@@.@..@@@@@@@.@@..@..@@@.@.@@.@.@@@@..@@@@@.@@....@.@..@@@
.@@@@...@..@...@@@.@@@@@@@.@@.@@@@.@@@@.@.@...@@@@.@...@@@.@@@@.@@..@..@@.@@.@@.@@...@...@@@@@@@@@.@@..@@..@@..@@@.@@.@@@@..@@@@@@.@@@@
@@.@@.@@@@.@...@.@..@.@...@@.@@.@@.@...@@@@.@@@@@@@@.@..@.@@@@@.@.@.@..@@@.@@@@@.@@@@.@....@@.@.@.@@@@@.@..@@@@@@@@@.@.@@@@@@.@..@@@.@@
@...@.@...@@@@.@@@.@@@@@.@@.@.@@@..@.@@@@@.@.@@@@@..@@@@.@@..@.....@.@..@.@.@.@@@@..@@@@@.....@@@@@@.@.@@@.@@@@.@@.@@@@@@@.@..@.@@.@.@.
@@@.@@@@.@..@.@..@@.@@@@.@@..@@..@@@@@.@@@.@..@.@@@@.@@.@@@@@@.@@.@@@.@@.@.@@.@.@@@@@@...@.@..@..@@....@.@@@.@.@@@.@@.@@@@@.@..@@@.@.@@
@.@@.@@@.@@@@@@@...@..@@@@@@@.@..@.@@@..@@@.@@@@.@@@.@@..@.@@@.@@...@@...@@@@...@.@@@@@@@.@.@@@.@@...@...@@@.@.@@@@.@@@@.@@@@.@.@.@.@..
@.@@@@@..@@@@..@.@.@@@..@@@@.@@@@@@@@@@@@@...@@@@.@.@...@@@@@@@@@@@@@@@..@@.@@..@@...@@@.@@.@@@..@@@@@@.@.@.@@@@@@@@@@@.@.@..@@@@@..@@.
@.@@.@@@@@.@..@.@.@@@@....@@@@...@@@...@@.@@@@@@@@.@@@@..@@@@@.@@@@.@@@.@@@@@@@..@.@.@@@@@@...@.@@..@..@.@.@@@..@@.@@@@@.@@.@@@@.@@@..@
@@..@@.@@@@.@..@.@.@@@.@@..@.@@@@@.@@...@@@.....@@.@@@@@@@@@.@.@.@@.@@@.@....@@@@..@@.@@..@.@..@@..@.@@@.@@@@@@@.@@@.@@.@.@.....@..@@@.
@.@@..@@@...@.@.@@@@..@@@..@@.@...@@.@..@@..@.@@@@@@.@..@.@..@@@@@.@@@@@@@@..@@@@@...@.@@@.@@@.@.@@@..@@@@@@@.@@@@@.@..@@@@@@@.@@.@@@..
@@@@@@@.....@@@@@@@.@@.@.@@@@@@@@.@.@.@@@@@@.@@..@..@@@.@@@@.@@@..@.@....@@@.@@@.@.@@@@...@@@@..@..@@@@.@.@.@@..@@...@.@@@@@.@@@@@@@.@.
@..@@@.@@@@@@@...@.@@@@@.@@..@@@@.@@@.@@@@.@.....@@.@@.@..@@@@@..@@@..@@@@..@@@@@.@@@..@@@@@@..@.@@@@..@@@@@.@@@.@..@.@@@@@@@@@.@.@@@@@
...@.@@...@@@@..@@.@...@.....@...@.@@@@.@@@@.@@..@@@@@@.@@@..@.@@..@.@@...@@.@.@@@@@@@@@..@@@@@@@@...@@@@@@.@@@.@.@.@@.@@..@.@@@@@@@@@.
@.@.@@@.@@@@@...@.@.@@@@@.@.@@@@.@@@..@@@@@@@@@@@@@.@..@@@@@..@@@@@@@.@..@.@@@.@@.@..@@@@@@.@@@@@@@@@..@@@@.@@..@@@@.@@@.@@@@.@@@@@.@..
.@.@.@@...@.@@..@.@@@@@.@@@@.@@@.@.@@@@@.@@..@@@...@.@@..@.@@.@@@@@@..@.@@...@.@@@@@@.@.@@@..@@.@@.@@@@.@@..@@@@@@.@@..@@@.@@@@@.@.....
@.@@.@@@@..@@....@@@@@@.@@@.@@@@...@@@@@..@.@@.@@@@...@@@.@.@@@...@@@.@@@@@@.@..@@@@@@..@.@..@.@.@@@@@..@@.@@.@@@@@@@@@@.@@..@@@.@@@.@.
...@.@@@@.@.@@.@..@@@....@@@.@@@.@@..@..@@@@@@@..@@@@@@@@.@..@@@....@@@..@@.@@.@@..@@@@@@@@@.@.....@@@.@@..@@@@.@@.@@@@@@@@@@@.@.@.@.@@
@.@@@@@@@.@@.@...@@.@@@....@@@@@.@@.@@.@@@@@@@...@@..@@@@.@@@.@.@@.@@@@@@@@@.@@.@@@@@@@..@.@..@@@.@@.@.@.@@.@.@@.@@@.@.@@..@@@@.@@.@@@@
.@@.@@.@@@@..@..@@@@.@.@@@@.@.@@@@@.@......@.@@@@.@@@@@@.@@@.......@@@.@..@.@@..@@@@@@..@@...@@@@.@@@@@@@..@.@.@@@@.@@..@@@@.@@@@@@.@@@
@@@@.@.@@@@.@.@@@@@@@.@@@@@.@@@@@.@@@@.@.@@@@.@@.@@..@@.@..@@@..@@@..@@...@@@@.@@@@.@..@.@@.@@@@@@.@@...@@@@@@@@@@@@@@@@@@@@@@@..@@.@@@
@@@@@.@..@..@@.@.@@@..@@.@@..@....@@@@..@.@@....@@.@.@.@.@@@.@@@..@@@...@@..@@....@@..@@..@@..@@@@@..@@@@@@..@.@@@.@.@.@.@@@..@..@.@.@.
.@@.@.@@...@@@@..@@.@.@@@@@.....@.....@@.@@..@@@..@@@..@@.@..@@@@.@@@@@.@..@@@.@..@@...@..@@...@@@.@@@.@@@@.@@.@.@@..@@@@...@.@@@@@.@@@
@@@@@..@@.@@@.@..@@@@@@.@.@@@.@@..@@@@@@@..@.@.@@@.@@@@@......@....@@@@@.@@..@.@.@@@.@@@@@@@..@@@@@.@@..@.@@@@@..@.@.@@@@@...@..@@@..@.
@@.@@.@.@@@..@@@.@@..@@@.@@@.@@@@@@@..@@@@.@.@@@@@@.@..@..@@..@.@..@@@@@@@@@@.....@@@@.@.@@.@@@@..........@@.@@@.@@@..@@@.......@@@@@@@
...@.@@@@@@@@.@@@.@.@@@@@.@@....@...@.@@@@@@.@...@@@.@@@@..@@@@@...@.@@@@@@@@@.@..@@@@@@@.@@@.....@@@@@@@..@.@@@@@@.@.@@@@@@@@@@@@@@.@.
..@@@.@@@@.@@@@.@..@@.@.@@.@@.@@...@@.@@@@@.@@@@@@...@...@@@..@@..@@.@@.@@@.@@@@@@..@@@.@@@@.@@@@@.@.@@@.@@@@@.@@@.@@@@@@@@@.@@..@.@@@@
.@@@@@.@@.@.@@@@.@@..@@..@@@@@@@.@.@@@.@@@@@@@.@@.@@@@@.@.@@.@...@@......@.@..@.@@..@@@..@@@@@@@..@@@.@@@@@.@@@@@.@..@..@@..@@.@.@..@@@
@@@@....@@.@.@..@@.@@@@.@@@@@@..@@.@@@.@@@@@@@.@@.@.@...@@@@...@.@.@@@.@@@..@..@@@@@@@@@@@.@.@.@@@@@@@.@.@@@@.@@@@@.@@@.@@@@@@.@@@.@@@@
..@@@@@@.@@.@.@@.@..@.@@@.@@@@@.@@@@@.@@@@@@@@.@.@@@@@@@@@@@.@@@.@@@@.@@@@@@@@..@@@@@@@..@@@@@@.@.@.@@@...@@@.@@@..@@@@.@@.@@.@.@@.@@@@
@@.@@.@.@@.@@.@.@@@@@.@@..@....@...@@@@@@@..@..........@@@@@..@.@.@@@.@..@...@@@@.@@@@@@.@@@@@.@@.@.@.@@.....@@@.@..@@@@@@.@@@@@@@@@@@@
@@.@@.....@@.@@.@@..@.@.@.@@@...@@.@@@@..@@..@@@.@.@@@.@@@.@@.@.@@@@@@.@.@@@@@@..@@@.@..@@@..@@.@@@@.@@@@@@@@@@@@@@.@@@@.@@..@@...@@@@@
@@..@@..@@.@@@...@@@@@@@...@@@@@@@.....@.@@.@@@.@@@@@@..@..@@@@@@.@@...@@....@@@..@.@@@.@...@@@@@@.@@@@.@.@.@@@@@@@@.@.@.@..@.@@@@.@@@.
@..@@@@..@..@@@..@.@@@@@@.@.@..@.@@@@.@@@.@@@@@@@@@@@....@.@@@@@@@@@.@@@@@@@.@.@.@@@@@.....@@@@@@@@@@@..@.@.@.@@@@@@@@@@@.@@@.@.@@.@.@.
....@...@@@.@@....@@@.@@@@..@@@....@@@@@@..@.@..@.@@@.@..@.@@.@@@.@.@..@.@@.@@@..@@..@..@@@.@@@...@.....@@@@@.@@@@@@@.@@..@@@.@...@.@@.
@@@@@.@@@@@.@@..@@@@@@@@@@@...@@@.@.@@.@@@.@.@..@.@@@..@.@@@@@.@@.@@@@@@.@@@@.@..@@@.@@.@@@@@@..@..@...@@@.@@.@@@@@@..@@@@@@@@@@@@@.@..
@.@.@@..@@@@@@..@.@.@@..@.@@.@..@@@.@@@@@.@@@@@@@@.@..@.@.@@@@@@@.@.@@@@@@@@@@@@@@@.@@.@@@@@.@@.@@@@.@@@.@@.@.@@.@@.@@@@@@@...@@...@@@.
.@...@@@.@.@..@@@@.@@...@@...@..@@..@.@@@@@@@@@@.@..@.@@@..@@.@..@@@.@@@@.@@..@.@@....@@@@@@.@@.@....@@..@@.@@.@@@...@..@@.@@..@@@@@@@@
@@@.@.@@@@@@.@@@@...@.@@@@@@@.@..@.@@@@@@@@@.@@.@.....@..@@..@.@@@@@.@.@@@@@@@@@@.@.@@.@@@@@@..@@..@@@@@@..@@@@.@....@@@@...@@...@@@.@.
..@@@@..@@@.@@.@@@@@@@@@@@...@@@@.@@.@@.@@@@....@.@@..@@..@@@.@@@.@@@@@@.@..@@....@.@@@.@@...@.@@@@@..@@@@@@@.@@@@@@@.@.@@@..@.@...@@@@
.@@@..@@@@@@@@@@..@@@.@..@@@.@@.@.@@....@@..@...@@@.@@@@@.@...@.@@.@@....@@@@@..@@..@.@@@@@@@@@.@@@@@.@@@@.@@@@@@.@.@@@....@@@..@@@..@.
@.@@.@@.@..@..@@@@@@@.@@@@.@@.@..@.@.@.@.@.@@...@@@@@@@@@@@@..@@@@@..@@@@..@@..@@.@@@@@.@@@@@@@.@.@@.@....@@@@.@@@@@@@.@...@.@@.@@.@@.@
..@..@@@@@.@.@@.@@.@.@@@@@@@.@@@@@@@@@.@@.@.@@.@@@@@@@@.@@@.@@.@.@@@@.@@.@@.@@..@.@..@@@@.@@..@@@.@@@..@@.@@@.@@@@.@@@@@..@@.@@@@@....@
@@@@.@@..@@@@@@@@@.@.@@@@..@@@.@@..@@@@.@@@@@@@@..@@@@@@..@.@.@@@...@@@@@.@.@@.@..@@@...@@@@@@@@@.@@@.@@@@@@@@@@.@@@@..@.@.@...@@@@.@@@
@@.@.@@.@..@@..@.@@@.@@@.@@.@..@@..@.@..@@...@.@@@@@.@@@@.@..@..@.@@@@@.@@.@@@.@.@.@@@@.@.@.@.@@@@@...@.@@@..@..@@@@@@@@@@@@@.@..@.@.@.
.@@@@@@@@.@@@@@@@@.@.@...@@@@@@@.@@.@@@@..@@..@@..@@@.@@@....@@.@@.@.@@@@...@.@.@@@..@@@.@.@@@@..@@@@...@@@@@@@@@..@..@..@@.@@..@@@.@.@
...@.@@@@@@@@..@.@@@@@@.@@@.@@.@.......@@@.@@@@..@@@@@..@@@@.@..@@.@@.@@@.@@..@@.@@@@.@@.@.@@@.@@@@...@.@.@@.....@@@...@@@...@@.@..@..@
@.@@@@.@@@...@..@@@@@@@.@...@@@@..@@...@.@.@@@@@.@..@..@@.@@@.@.@...@..@@@..@@.@@.@.@...@@.@@...@@..@.@@@@@@.@..@..@@.@@.@@@.@.@@@@@@.@
@..@.@@@@.@@@@@.@@@@@.@@@.@.@..@.@@..@@@.@@@@.@.@@@.@@.@@.@@.@.@@@@@.@@@.@@@@@@@.@@@@@@.@..@@@@@@@...@@.@.@.@.@@@@.@@@...@@@@...@.@@@.@
@@@@.@..@@@.@.@@.@@@@@.@.@@@...@@@..@@.@@@@@.@.@..@@..@@@.@@@@@..@@@@.@...@@@.@@@@@@.@.@@@@.@@@@.@@.@@@.@..@.@@....@@@@@@..@@@.@@@@@@@.
@@@.@@@.@...@@@.@@@.@@@@@@@..@@.@..@@@@@.@@@...@@.@@@@..@@@....@@@@@.@.@@@.@@@.@@...@.@@@@.@.@@@.@@@.@@@@@.....@.@@.@@@@.@@@@.@@..@@@@.
.@.@.@@@@@@@.@@.@@@..@..@@.@...@..@@@.@@.@@...@.@....@@..@.@...@..@@@@.@@@...@.@.@..@..@...@@@@@@@@.@..@@@@@@.@@@.@..@.@@@@@@@@@@@@.@..
@..@@..@.@@@...@@.@@@@@@@@@..@@.@@@@.@@@..@.@@@.@@@..@@@@.@.@@@.@@@@@...@@@@@@@@..@@@..@@@@..@@@@@@@.@..@@@@@@@.@..@@@@@@@..@..@@@@....
.@@@@.@@@@@.@@@.@@..@.@@@@@.@@@@@@@@.@.@.@...@..@.@.@.@@.@.@@@...@@@@@@@@...@@@.@.@.@@@@@.@@@@.@...@.@@@@@@@.@..@@@@@@@@@@.@@@@.@@.@@@@
@@.@@@.@..@.@.@@@..@@@@@@@@@.@@..@.@@.@@...@@.@.@@.@.@@@@.@@@@.@@@.@@..@@@@@@@.@...@.@@.@@@@....@@@@@..@.@@..@.@..@@@@.@@@@@@@..@.@@.@@
..@.@@@@@@@@.@@@..@@@.@@@...@@..@.@@@..@@@@.@@.@@@@..@@...@@.@@.@@@.@@@@@.@@@.@@...@@@...@@.@..@@@@..@@@@@@@...@@.@.@@.@..@@@..@@.@.@.@
@...@@@.@@.@@@.@@@@@@@@.@@@.@@@@@..@@.@@..@@@...@@@@@@@.@.@..@..@.@.@@.@.@@@.@.@@@@.@@@@.@...@@@.@.@@@@@@.@.@@@@@@@@@@@@@@@@@.@.@.@@@.@
.@.@@@@@.@.@@@@.@@@@.@@..@@@@@@@..@@@.@@.@.@@@@@.@@@@@@@@@@@@.@@@@...@.@.@@@..@@@..@.@..@@@@@@@@@.@@@@.@@@@...@@.@.@.@@.@.@@@@@@@@@@@@@
@@@@@.@@.@@..@@@@....@..@@@@@@@@@.@@@.@.@.@.@@@@@....@@.@.@@@@@.@@..@.@.@.@@@@@@@@@@@@..@.@.@.@@@..@@@@@.@@..@@@.@.@...@@.@@.@@@..@@@@.
@@.@@@@.@@..@@@.@.@@..@@.@@.@@..@@..@@@@.@@@@.@@@@@..@@@@.@.@...@@...@@@@@@.@@@@.@@@@@@.@@..@.@@@..@@.@.@.@@@.@@@..@@@@@@.@@@@@..@@.@@@
..@@@@.@@@@@@...@.@.@.@.@.@@@@@...@@@@@@@@.@@.@.@@@@.@@@@@@@@@..@.@@.@@@@.@.@@@.@@.@@.@@.@@@@.@..@@.@.@@@@.@@@@@@@.@@@@@@@@.@@..@@@@@@@
@@.@@@@.@@@@@@@@@...@.@@@@@@.@..@.@@.@..@@@@@.@@@.@.@@@.@.@.@@@@@@....@@@...@@@@..@@@@.@.@@@@@@.@@@@.@@@.@..@@@.@.@@.@@.@.@..@@@@@...@@
@..@@@@@.@@@@.@@@@@@.@.@@@@@@@@@@@@@..@@..@@@@.@@@..@..@@@@....@.@.@..@@@@.@@@@.@....@@@.@@@..@.@.@@...@...@.@.@.@@.@@@@@@@@@@@@@@@@.@@
..@@.@@@@.@@..@@@...@@@@@..@.@@..@@@@@.@.@@...@.@@@@.@....@@@..@@.@@.@@...@@@@.@@@@@@@.@..@@@@.@@@@@@@......@@@.@@..@@.@@@@@.@@@@.@.@.@
..@@@.@@.@.@@@@.@.@.@...@@@.@.@@@.@..@.@@@@..@@...@@@@@.@.@@@@@@@..@@@@.@@.@@@.@.@@.@@@@.@.@@@@@@@@@.@@@@@@@.@@@@..@@.@@@..@@@@@@@..@.@
.@.@@.@@..@@@.@@..@@@@..@.@@.@@@@@@@.@.@@.@...@...@@@.@..@@@@.@.@@@...@@@@@@@..@..@@@@@@@@@@.@@.@@@.@@@@.@.@@...@..@@@.@@@.@...@@@.@@.@";

pub fn run() {
    let now = Instant::now();
    part1();
    let elapsed = now.elapsed();
    println!("Part1 Elapsed: {}μs", elapsed.as_micros());

    let now = Instant::now();
    part2();
    let elapsed = now.elapsed();
    println!("Part2 Elapsed: {}μs", elapsed.as_micros());

    let now = Instant::now();
    part_2_actually();
    let elapsed = now.elapsed();
    println!("Part2 GPU Elapsed: {}μs", elapsed.as_micros());
}

fn sum_neighbors(pos: (isize, isize), dims: (isize, isize), grid: &Vec<Vec<usize>>) -> usize {
    let mut count = 0;
    let yr = (pos.1 - dims.0).max(0)..(pos.1 + dims.0 + 1).min(grid.len() as isize);
    for y in yr {
        let xr = (pos.0 - dims.1).max(0)..(pos.0 + dims.1 + 1).min(grid[y as usize].len() as isize);
        for x in xr {
            if x == pos.0 && y == pos.1 {
                continue;
            }
            count += grid[y as usize][x as usize];
        }
    }

    count
}

// 1344
fn part1() {
    let grid = INPUT
        .split('\n')
        .map(|line| {
            line.chars()
                .map(|c| match c {
                    '@' => 1,
                    _ => 0,
                })
                .collect::<Vec<usize>>()
        })
        .collect::<Vec<Vec<usize>>>();
    let mut count = 0;
    for y in 0..grid.len() {
        for x in 0..grid[y].len() {
            let sum = sum_neighbors((x as isize, y as isize), (1, 1), &grid);
            if sum < 4 && grid[y][x] == 1 {
                count += 1;
            }
        }
    }
    println!("{}", count);
}

fn part2() {
    let mut grid = INPUT
        .split('\n')
        .map(|line| {
            line.chars()
                .map(|c| match c {
                    '@' => 1,
                    _ => 0,
                })
                .collect::<Vec<usize>>()
        })
        .collect::<Vec<Vec<usize>>>();

    let mut count = 0;
    loop {
        let mut new_grid = grid.clone();
        let mut subcount = 0;
        for y in 0..grid.len() {
            for x in 0..grid[y].len() {
                let sum = sum_neighbors((x as isize, y as isize), (1, 1), &grid);
                if sum < 4 && grid[y][x] == 1 {
                    subcount += 1;
                    new_grid[y][x] = 0;
                }
            }
        }
        if subcount == 0 {
            break;
        }
        count += subcount;
        grid = new_grid.clone();
    }

    println!("{}", count);
}

fn part_2_actually() {
    tokio::runtime::Runtime::new()
        .unwrap()
        .block_on(part2_for_real());
}

async fn part2_for_real() {
    let instance = wgpu::Instance::new(&Default::default());
    let adapter = instance.request_adapter(&Default::default()).await.unwrap();
    let (device, queue) = adapter.request_device(&Default::default()).await.unwrap();

    let shader = device.create_shader_module(wgpu::include_wgsl!("day4.wgsl"));

    let input_data = INPUT.split('\n').collect::<Vec<_>>();
    let dx = input_data.len() as u32;
    let dy = input_data[0].len() as u32;
    let input_data = input_data
        .into_iter()
        .flat_map(|l| l.chars())
        .map(|c| match c {
            '@' => 1,
            _ => 0,
        })
        .collect::<Vec<u32>>();

    let input_buffer = device.create_buffer_init(&wgpu::util::BufferInitDescriptor {
        label: Some("input"),
        contents: bytemuck::cast_slice(&input_data),
        usage: wgpu::BufferUsages::COPY_DST | wgpu::BufferUsages::STORAGE,
    });

    let persist_buffer = device.create_buffer(&wgpu::BufferDescriptor {
        label: Some("persist"),
        size: input_buffer.size(),
        usage: wgpu::BufferUsages::STORAGE | wgpu::BufferUsages::COPY_SRC,
        mapped_at_creation: false,
    });

    let counter_buffer = device.create_buffer(&wgpu::BufferDescriptor {
        label: Some("counter"),
        size: std::mem::size_of::<u32>() as u64,
        usage: wgpu::BufferUsages::STORAGE,
        mapped_at_creation: false,
    });

    let bind_group_layout = device.create_bind_group_layout(&wgpu::BindGroupLayoutDescriptor {
        label: Some("Bind Group Layout"),
        entries: &[
            wgpu::BindGroupLayoutEntry {
                binding: 0,
                visibility: wgpu::ShaderStages::COMPUTE,
                ty: wgpu::BindingType::Buffer {
                    ty: wgpu::BufferBindingType::Storage { read_only: false },
                    has_dynamic_offset: false,
                    min_binding_size: None,
                },
                count: None,
            },
            wgpu::BindGroupLayoutEntry {
                binding: 1,
                visibility: wgpu::ShaderStages::COMPUTE,
                ty: wgpu::BindingType::Buffer {
                    ty: wgpu::BufferBindingType::Storage { read_only: false },
                    has_dynamic_offset: false,
                    min_binding_size: None,
                },
                count: None,
            },
            wgpu::BindGroupLayoutEntry {
                binding: 2,
                visibility: wgpu::ShaderStages::COMPUTE,
                ty: wgpu::BindingType::Buffer {
                    ty: wgpu::BufferBindingType::Storage { read_only: false },
                    has_dynamic_offset: false,
                    min_binding_size: None,
                },
                count: None,
            },
        ],
    });

    let bind_group = device.create_bind_group(&wgpu::BindGroupDescriptor {
        label: Some("BInd Group"),
        layout: &bind_group_layout,
        entries: &[
            wgpu::BindGroupEntry {
                binding: 0,
                resource: input_buffer.as_entire_binding(),
            },
            wgpu::BindGroupEntry {
                binding: 1,
                resource: persist_buffer.as_entire_binding(),
            },
            wgpu::BindGroupEntry {
                binding: 2,
                resource: counter_buffer.as_entire_binding(),
            },
        ],
    });

    let pipeline_layout = device.create_pipeline_layout(&wgpu::PipelineLayoutDescriptor {
        label: Some("Pipeline Layout Descriptor"),
        bind_group_layouts: &[&bind_group_layout],
        push_constant_ranges: &[],
    });

    let pipeline = device.create_compute_pipeline(&wgpu::ComputePipelineDescriptor {
        label: Some("Compute Pipeline"),
        layout: Some(&pipeline_layout),
        module: &shader,
        entry_point: Some("main"),
        compilation_options: PipelineCompilationOptions::default(),
        cache: None,
    });

    let mut encoder = device.create_command_encoder(&wgpu::CommandEncoderDescriptor {
        label: Some("Encoder"),
    });

    let mut compute_pass = encoder.begin_compute_pass(&wgpu::ComputePassDescriptor {
        label: Some("Compute Pass"),
        timestamp_writes: None,
    });

    for _ in 0..60 {
        compute_pass.set_pipeline(&pipeline);
        compute_pass.set_bind_group(0, &bind_group, &[]);
        compute_pass.dispatch_workgroups(dx.div_ceil(16), dy.div_ceil(16), 1);
    }

    drop(compute_pass);

    let temp_buffer = device.create_buffer(&wgpu::BufferDescriptor {
        label: Some("temp"),
        size: input_buffer.size(),
        usage: wgpu::BufferUsages::COPY_DST | wgpu::BufferUsages::MAP_READ,
        mapped_at_creation: false,
    });

    encoder.copy_buffer_to_buffer(&persist_buffer, 0, &temp_buffer, 0, temp_buffer.size());

    queue.submit(Some(encoder.finish()));

    let (tx, rx) = mpsc::channel();

    temp_buffer.map_async(wgpu::MapMode::Read, .., move |res| tx.send(res).unwrap());

    device.poll(wgpu::PollType::wait_indefinitely()).unwrap();

    rx.recv().unwrap().unwrap();

    let output_data = temp_buffer.get_mapped_range(..);
    let output: &[u32] = bytemuck::cast_slice(&output_data);

    println!("{}", output.iter().sum::<u32>());
}
